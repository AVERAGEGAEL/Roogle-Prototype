<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: #fff;
      height: 100vh;
      overflow: hidden;
    }

    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loadingMessage { font-size: 18px; color: #333; margin-bottom: 15px; }
    #loadingSpinner {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #4285f4;
      border-radius: 50%;
      width: 55px; height: 55px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    #timeoutMessage {
      display: none; margin-top: 20px;
      color: red; font-size: 16px; text-align: center; max-width: 80%;
    }

    #closeOverlay {
      margin-top: 20px; padding: 6px 12px;
      font-size: 14px; border: none; border-radius: 4px;
      background: #d33; color: white; cursor: pointer;
    }
    #closeOverlay:hover { background: #b22; }

    #proxyIframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div id="loadingMessage">üîÑ Loading site... (0s)</div>
    <div id="loadingSpinner"></div>
    <div id="timeoutMessage">‚è≥ This is taking longer than usual.<br>Trying fallback...</div>
    <button id="closeOverlay">‚ùå Dismiss</button>
  </div>

  <iframe id="proxyIframe" sandbox="allow-scripts allow-forms allow-same-origin allow-popups allow-top-navigation"></iframe>

  <script>
    const overlay = document.getElementById("loadingOverlay");
    const msg = document.getElementById("loadingMessage");
    const timeoutMsg = document.getElementById("timeoutMessage");
    const iframe = document.getElementById("proxyIframe");

    const workers = [
      "https://cloud1.uraverageopdoge.workers.dev",
      "https://cloud2.rageinhaler.workers.dev",
      "https://cloud3.kevinthejordan.workers.dev"
    ];
    let workerIndex = 0;

    // timer stays independent
    let elapsed = 0;
    const timer = setInterval(() => {
      elapsed++;
      msg.textContent = `üîÑ Loading site... (${elapsed}s)`;
      if (elapsed >= 30) timeoutMsg.style.display = "block";
    }, 1000);

    // hide overlay if told
    window.addEventListener("message", e => {
      if (e.data?.type === "hideLoading") {
        overlay.style.display = "none";
        clearInterval(timer);
      }
    });

    document.getElementById("closeOverlay").onclick = () => {
      overlay.style.display = "none";
      clearInterval(timer);
    };

    function logDebug(message, level = "info") {
      parent.postMessage({ type: "debugLog", message, level }, "*");
    }

    async function loadViaWorker(url) {
      const backend = workers[workerIndex % workers.length];
      const proxied = `${backend}/proxy?url=${encodeURIComponent(url)}`;
      logDebug(`Using backend: ${backend}`);

      iframe.src = proxied;

      const failTimeout = setTimeout(() => {
        logDebug(`‚ö†Ô∏è ${backend} timed out`, "warn");
        nextWorker(url);
      }, 8000);

      iframe.onload = () => {
        clearTimeout(failTimeout);
        logDebug("‚úÖ Iframe loaded successfully.");
        overlay.style.display = "none";
        clearInterval(timer);
        parent.postMessage({ type: "hideLoading" }, "*");
      };

      iframe.onerror = () => {
        clearTimeout(failTimeout);
        nextWorker(url);
      };
    }

    function nextWorker(url) {
      workerIndex++;
      if (workerIndex < workers.length) {
        logDebug("üîÅ Retrying with next Cloudflare Worker...");
        loadViaWorker(url);
      } else {
        logDebug("‚ö†Ô∏è All Cloudflare Workers failed. Using Service Worker fallback.", "error");
        timeoutMsg.textContent = "All Cloudflare Workers failed ‚Äî switching to local fallback...";
        timeoutMsg.style.display = "block";
        loadViaServiceWorker(url);
      }
    }

    async function loadViaServiceWorker(url) {
      try {
        if ("serviceWorker" in navigator) {
          await navigator.serviceWorker.register("sw-proxy.js", { scope: "./" });
          logDebug("‚úÖ Service Worker registered as fallback.");
        }
        iframe.src = `/proxy?url=${encodeURIComponent(url)}`;
        iframe.onload = () => {
          overlay.style.display = "none";
          clearInterval(timer);
        };
      } catch (err) {
        logDebug("‚ùå SW fallback failed: " + err, "error");
        msg.textContent = "All methods failed. Try again later.";
        document.getElementById("loadingSpinner").style.display = "none";
      }
    }

    (function initProxy() {
      const params = new URLSearchParams(location.hash.slice(1));
      const target = params.get("url");
      if (!target) {
        msg.textContent = "‚ùå Missing target URL.";
        timeoutMsg.textContent = "Add #url=https://example.com to the URL.";
        timeoutMsg.style.display = "block";
        return;
      }
      logDebug(`Starting load: ${target}`);
      loadViaWorker(target);
    })();
  </script>
</body>
</html>
